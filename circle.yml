machine:
  timezone:
    Europe/Warsaw
  environment:
    GOPATH: "/home/ubuntu/.go"
    GOVERSION: "1.5.3"
    GO15VENDOREXPERIMENT: 1
    PATH: "${PATH}:${GOPATH}/bin"
    TAG: $CIRCLE_BUILD_NUM
    HOME: "${GOPATH}/src/github.com/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}"
  services:
    - docker

checkout:
  post:
    - mkdir -p $GOPATH/src/github.com/$CIRCLE_PROJECT_USERNAME
    #- ln -snf $HOME/$CIRCLE_PROJECT_REPONAME $GOPATH/src/github.com/$CIRCLE_PROJECT_USERNAME

dependencies:
  pre:
    - mkdir -p /home/ubuntu/goinstall
    - wget -qO - https://storage.googleapis.com/golang/go$GOVERSION.linux-amd64.tar.gz | tar zxf - -C /home/ubuntu/goinstall --strip-components 1
    - sudo rm -rf /usr/local/go
    - sudo ln -snf /home/ubuntu/goinstall /usr/local/go
    - go version
    - go get github.com/alecthomas/gometalinter
    - gometalinter --install
  override:
    - ls vendor

  # cache the go install
  cache_directories:
    - /home/ubuntu/goinstall
    - /home/ubuntu/.go

test:
  override:
    - pwd
    - make build
    - ./exago -version
    - make check
    - make test

deployment:
  release:
    branch: master
    commands:
      - docker login -u $REGISTRY_USERNAME -p $REGISTRY_PASSWORD -e $REGISTRY_EMAIL
      - docker build -t jgautheron/exago-service:$TAG .
      - docker push jgautheron/exago-service:$TAG
